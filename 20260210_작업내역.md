# 작업내역 - 2026.02.10

## 개요
회원가입, API 키 연결, 라우팅 흐름 전반의 버그 수정 및 안정화 작업

---

## 1. 회원가입 에러 수정 (`89b25eb`)

### 문제
- 회원가입 시 "등록 실패 - 서버 연결에 실패했습니다" 에러 발생
- 실제 원인: Supabase `handle_new_user()` 트리거 함수 오류

### 원인
- 트리거 함수에 `SET search_path = public`이 없어 테이블을 못 찾음
- 충돌 처리(`ON CONFLICT`) 미비
- 에러 발생 시 무조건 실패 → 회원가입 전체 rollback

### 수정 내용
- **Supabase 트리거 재생성**: `SET search_path = public`, `ON CONFLICT (id) DO UPDATE`, `EXCEPTION WHEN others` 추가
- **AuthContext.tsx**: `register()` 함수가 실제 에러 메시지를 throw 하도록 변경 (기존: `return false`)
- **RegisterForm.tsx**: `try/catch`로 에러를 받아 `parseAuthError()`로 한/영 에러 메시지 표시
- **authErrors.ts**: 신규 파일 - 에러 패턴별 사용자 친화적 메시지 매핑

### 수정 파일
| 파일 | 변경 |
|------|------|
| `src/contexts/AuthContext.tsx` | register() throw 에러로 변경 |
| `src/components/auth/RegisterForm.tsx` | try/catch + parseAuthError 적용 |
| `src/utils/authErrors.ts` | 에러 패턴 파서 신규 생성 |

---

## 2. Gemini API 모델명 통일 및 에러 메시지 개선 (`ff80f6e`)

### 문제
- `AIAssistantConnect.tsx`에서 `gemini-1.5-flash` 사용 → deprecated 가능
- `geminiClient.ts`에서는 `gemini-2.0-flash` 사용 → 불일치

### 수정 내용
- 모델명을 `gemini-2.0-flash`로 통일
- catch 블록에 실제 Google API 에러 메시지를 UI에 표시하도록 개선

### 수정 파일
| 파일 | 변경 |
|------|------|
| `src/components/marketing/AIAssistantConnect.tsx` | 모델명 통일, 에러 메시지 개선 |

---

## 3. API 키 저장 시 "로그인 정보 없음" 에러 수정 (`98a2ae0`)

### 문제
- AI 비서 연결 페이지(`/ai-welcome`)에서 API 키 입력 후 "로그인 정보를 찾을 수 없습니다" 에러 발생
- 회원가입 직후 AuthContext의 `user`가 아직 null인 상태에서 `user?.id`를 체크하던 것이 원인

### 수정 내용
- **localStorage에 먼저 저장** (항상 성공)
- **Supabase 세션에서 직접 userId 조회** (`supabase.auth.getSession()`) - AuthContext 의존 제거
- DB 저장은 best-effort (실패해도 에러 표시 안 함)

### 수정 파일
| 파일 | 변경 |
|------|------|
| `src/pages/AIWelcomePage.tsx` | user 의존 제거, localStorage 우선 저장, 세션 폴백 |

---

## 4. 학생등록/AI비서 등록 후 커리큘럼 자동 이동 (`e912e00`)

### 문제
- 학생등록 → AI 비서 등록까지 마쳐도 `/` (카드 선택 화면)으로 돌아감
- 또다시 학생등록을 하게 만드는 무한 루프 발생

### 원인 분석
1. **RegisterCompletePage** → AIWelcomePage 이동 시 `schoolId`를 state로 전달하지 않음
2. **AIWelcomePage**의 `redirectPath`가 `/${schoolId}/hub` → schoolId가 undefined라 `/`로 이동
3. **GatewayPage**에 로그인+등록된 사용자를 자동 리다이렉트하는 로직 없음

### 수정 내용

**RegisterCompletePage**
- "AI 비서 연결하기" 버튼: `navigate('/ai-welcome', { state: { schoolId: 'marketing' } })`
- "나중에 하기" 버튼: `navigate('/marketing/hub')`

**AIWelcomePage**
- `redirectPath`를 `/marketing/school/curriculum`으로 고정
- API 키 저장 완료 후 바로 커리큘럼 페이지로 이동

**GatewayPage**
- 이미 로그인 + 마케팅 등록된 사용자가 `/`에 접근하면 자동으로 `/marketing/hub`로 리다이렉트

### 수정 후 라우팅 흐름
```
[신규 사용자]
마케팅 카드 클릭 → /congrats → /register → /register-complete
  → AI 비서 연결 → /ai-welcome → /marketing/school/curriculum ✅
  → 나중에 하기 → /marketing/hub ✅

[기존 등록 사용자]
/ 접속 → 자동 → /marketing/hub ✅
마케팅 카드 클릭 → /marketing/hub ✅
```

### 수정 파일
| 파일 | 변경 |
|------|------|
| `src/pages/RegisterCompletePage.tsx` | schoolId 전달 + 스킵 경로 수정 |
| `src/pages/AIWelcomePage.tsx` | redirectPath를 커리큘럼으로 고정 |
| `src/pages/GatewayPage.tsx` | 등록 사용자 자동 리다이렉트 추가 |

---

## Supabase DB 작업

### 트리거 함수 재생성
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
  RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER
  SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, email, name, role, created_at, updated_at)
  VALUES (
    NEW.id, NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'name', 'User'),
    COALESCE((NEW.raw_user_meta_data->>'role')::user_role, 'student'::user_role),
    NOW(), NOW()
  )
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    name = EXCLUDED.name,
    updated_at = NOW();
  RETURN NEW;
EXCEPTION WHEN others THEN
  RAISE LOG 'handle_new_user failed for %: %', NEW.email, SQLERRM;
  RETURN NEW;
END;
$$;
```

### API 키 컬럼 추가
```sql
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS gemini_api_key TEXT DEFAULT NULL;
```

---

## 5. 등교/커리큘럼/도구함 탭 활성화 및 자동 enrollment (`2b7a9c8`)

### 문제
- 등교, 커리큘럼, 도구함 3개 탭이 활성화되지 않음 (빈 화면)
- 회원가입 완료 후에도 마케팅 카드를 누르면 다시 등록 흐름으로 돌아감

### 원인 분석
1. **enrollment 미생성**: 회원가입 과정에서 `enrollments` 테이블에 레코드가 안 만들어짐
   - TrackCard가 `enrollments.some(e => e.school_id === 'marketing')`으로 체크 → false → 미등록으로 판단
   - 다시 `/congrats`로 보내는 무한 루프 발생
2. **user 로딩 중 빈 화면**: 3개 탭 모두 `if (!user) return null` → AuthContext의 user가 아직 로딩 중이면 아무것도 안 보임

### 수정 내용

**AuthContext.tsx**
- `register()` 함수에서 회원가입 완료 후 `createEnrollment(userId, 'marketing', null)` 자동 호출
- 별도의 enrollment 생성 단계 없이 회원가입만으로 마케팅 학교 등록 완료

**MarketingHubPage.tsx**
- `isLoading` 체크 추가 → 로딩 중 전체 화면 스피너 표시

**AttendanceTab.tsx / CurriculumTab.tsx / LabTab.tsx**
- `isLoading` 체크 추가 → 로딩 중 스피너 표시 (기존: 빈 화면)

### 수정 파일
| 파일 | 변경 |
|------|------|
| `src/contexts/AuthContext.tsx` | register()에 createEnrollment 추가 |
| `src/pages/marketing/MarketingHubPage.tsx` | user 로딩 스피너 추가 |
| `src/pages/marketing/school/AttendanceTab.tsx` | user 로딩 스피너 추가 |
| `src/pages/marketing/school/CurriculumTab.tsx` | user 로딩 스피너 추가 |
| `src/pages/marketing/school/LabTab.tsx` | user 로딩 스피너 추가 |

### 기존 테스트 계정 수동 enrollment 추가 SQL
```sql
INSERT INTO enrollments (student_id, school_id, status)
SELECT id, 'marketing', 'pending_info' FROM profiles WHERE role = 'student'
ON CONFLICT DO NOTHING;
```

---

## Supabase DB 작업

### 트리거 함수 재생성
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
  RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER
  SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, email, name, role, created_at, updated_at)
  VALUES (
    NEW.id, NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'name', 'User'),
    COALESCE((NEW.raw_user_meta_data->>'role')::user_role, 'student'::user_role),
    NOW(), NOW()
  )
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    name = EXCLUDED.name,
    updated_at = NOW();
  RETURN NEW;
EXCEPTION WHEN others THEN
  RAISE LOG 'handle_new_user failed for %: %', NEW.email, SQLERRM;
  RETURN NEW;
END;
$$;
```

### API 키 컬럼 추가
```sql
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS gemini_api_key TEXT DEFAULT NULL;
```

### 기존 학생에 enrollment 추가
```sql
INSERT INTO enrollments (student_id, school_id, status)
SELECT id, 'marketing', 'pending_info' FROM profiles WHERE role = 'student'
ON CONFLICT DO NOTHING;
```

---

## 커밋 이력 (이번 세션)
| 커밋 | 설명 |
|------|------|
| `89b25eb` | 회원가입 에러 처리 개선 및 Supabase 트리거 안정화 |
| `ff80f6e` | Gemini API 모델명 통일 및 에러 메시지 개선 |
| `98a2ae0` | API 키 저장 시 로그인 정보 없음 에러 수정 |
| `e912e00` | 학생등록/AI비서 등록 후 커리큘럼으로 자동 이동 |
| `2b7a9c8` | 등교/커리큘럼/도구함 탭 활성화 및 자동 enrollment |

---

## 배포
- **플랫폼**: Vercel (자동 배포, main 브랜치 push 시)
- **URL**: `kiosk-seven-gamma.vercel.app`
- **상태**: `2b7a9c8` push 완료 → 배포 완료

---

## 알려진 이슈 / 다음 작업
- 기존에 가입한 테스트 계정은 enrollment이 없으므로 위 SQL로 수동 추가 필요
- Vercel 배포 후 브라우저 캐시로 구버전이 보일 수 있음 → `Ctrl+Shift+R` 또는 개발자도구에서 "Clear site data"
