# 멀티 학교 등록(Enrollment) 시스템 구현 요약

**작성일시:** 2026-02-08
**프로젝트:** Kiosk Seven (이주민/유학생 교육 플랫폼)
**백엔드:** Supabase (PostgreSQL + Auth + RLS)

---

## 완료된 작업

### Phase 0: Supabase 셋업
- `.env.local` 생성 (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)
- `src/lib/supabase.ts` — Supabase 클라이언트 초기화
- `@supabase/supabase-js` 패키지 설치
- `supabase-schema.sql` — 전체 DB 스키마 (6개 테이블 + RLS 정책 + 트리거)

### Phase 1: Auth 마이그레이션
- `src/types/auth.ts` — User 타입 간소화 (subscription, schoolProgress 제거 → enrollment으로 이동)
- `src/contexts/AuthContext.tsx` — localStorage 더미 → Supabase Auth로 전면 교체
  - `signInWithPassword`, `signUp`, `signOut`
  - `onAuthStateChange` 리스너로 세션 복원

### Phase 2: Enrollment 데이터 레이어
- `src/types/enrollment.ts` — SchoolId, Enrollment, SchoolProfile, SchoolField 타입 + SCHOOL_NAMES 상수
- `src/types/database.ts` — DB 테이블 Row 타입 (ProfileRow, EnrollmentRow 등)
- `src/data/schoolFields.ts` — 학교별 추가 필드 정의
  - 디지털: PC경험, 기기보유, 학습목표
  - 마케팅: SNS계정, 사업유형, 마케팅경험
  - 취업: 비자유형, 한국근무경력, 희망업종, 한국어수준(TOPIK)
- `src/services/enrollmentService.ts` — enrollment CRUD (생성/조회/상태변경)
- `src/services/profileService.ts` — profile CRUD (조회/수정/검색)

### Phase 3: Enrollment Context
- `src/contexts/EnrollmentContext.tsx` — 등록 상태 관리 Provider
  - enrollments, activeEnrollments, pendingEnrollments
  - submitSchoolInfo, refreshEnrollments
- `src/App.tsx` — EnrollmentProvider 래핑 추가

### Phase 4: Enrollment UI 컴포넌트
- `src/components/enrollment/SchoolEnrollmentForm.tsx` — 동적 추가 정보 폼 (select/multiselect/textarea/number/text)
- `src/components/enrollment/SchoolEnrollmentModal.tsx` — pending 등록 시 모달
- `src/components/enrollment/PendingEnrollmentBanner.tsx` — 상단 알림 배너

### Phase 5: 관리자 Enrollment 관리
- `src/components/admin/StudentEnrollmentManager.tsx` — 학생 검색 + 학교 연결/해제/재활성화 UI
- `src/components/admin/AdminDashboard.tsx` — "등록 관리" 탭 추가

### Phase 6: 게이트웨이 + 프로필
- `src/pages/GatewayPage.tsx` — PendingEnrollmentBanner 연동
- `src/pages/ProfilePage.tsx` — "내 학교" 섹션 추가 (등록 상태별 아이콘/뱃지)

### Phase 7: i18n (다국어)
- `public/locales/ko/common.json` — enrollment.* 한국어 키 추가 (29개+)
- `public/locales/en/common.json` — enrollment.* 영어 번역 추가
- i18n sync 스크립트로 12개 추가 언어에 자동 전파

### RegisterForm 멀티스텝
- `src/components/auth/RegisterForm.tsx` — 3단계 폼으로 전면 재작성
  1. 공통정보 (이름, 이메일, 비밀번호, 소속 등)
  2. 학교선택 (3개 학교 카드 + "나중에 선택" 옵션)
  3. 추가정보 (선택한 학교의 SchoolEnrollmentForm)

### 빌드 에러 수정
- `SchoolManagement.tsx` — 미사용 import `getCompletedStampCount` 제거
- `StudentEnrollmentManager.tsx` — 미사용 `t`, `handleReactivate` 문제 수정
- `RegisterForm.tsx` — 미사용 `ArrowLeft`, `SCHOOL_ADDITIONAL_FIELDS`, `SchoolField` 제거
- `schoolStorage.ts` — 미사용 `StampProgress`, `GraduationStatus` import 제거
- `ROASSimulatorTool.tsx` — 미사용 `simDone` state 제거

---

## 미완료 작업

### 필수 (사용자 직접 수행 필요)
| 작업 | 설명 |
|------|------|
| **Supabase SQL 스키마 실행** | `supabase-schema.sql`을 Supabase 대시보드 → SQL Editor에서 실행 |
| **이메일 확인 비활성화 (개발용)** | Supabase → Auth → Settings → "Enable email confirmations" 끄기 |

### 기술적 검증
| 작업 | 설명 |
|------|------|
| **`npm run build` 최종 확인** | 모든 미사용 변수 수정 후 클린 빌드 확인 필요 |
| **브라우저 통합 테스트** | 회원가입 → 로그인 → 학교등록 → 관리자연결 흐름 실제 테스트 |

### 향후 개선사항
| 작업 | 설명 |
|------|------|
| **VisibilityContext 마이그레이션** | localStorage → instructor_settings 테이블로 이전 |
| **schoolStorage.ts 교체** | 로컬 스토리지 기반 → Supabase school_progress 테이블 |
| **데이터 마이그레이션** | 기존 localStorage 데이터 → Supabase 이전 스크립트 |
| **VITE_USE_SUPABASE 피처 플래그** | 점진적 전환을 위한 플래그 (선택사항) |

---

## 파일 구조 요약

```
src/
├── lib/
│   └── supabase.ts                          # [NEW] Supabase 클라이언트
├── types/
│   ├── auth.ts                              # [MOD] User 타입 간소화
│   ├── enrollment.ts                        # [NEW] 등록 관련 타입
│   └── database.ts                          # [NEW] DB Row 타입
├── data/
│   └── schoolFields.ts                      # [NEW] 학교별 추가 필드 정의
├── services/
│   ├── enrollmentService.ts                 # [NEW] Enrollment CRUD
│   └── profileService.ts                    # [NEW] Profile CRUD
├── contexts/
│   ├── AuthContext.tsx                       # [MOD] Supabase Auth
│   └── EnrollmentContext.tsx                 # [NEW] Enrollment 상태 관리
├── components/
│   ├── auth/
│   │   └── RegisterForm.tsx                 # [MOD] 3단계 멀티스텝
│   ├── enrollment/
│   │   ├── SchoolEnrollmentForm.tsx          # [NEW] 동적 추가정보 폼
│   │   ├── SchoolEnrollmentModal.tsx         # [NEW] 모달 래퍼
│   │   └── PendingEnrollmentBanner.tsx       # [NEW] 상단 배너
│   └── admin/
│       ├── AdminDashboard.tsx               # [MOD] 등록 관리 탭 추가
│       └── StudentEnrollmentManager.tsx     # [NEW] 학생 등록 관리
├── pages/
│   ├── GatewayPage.tsx                      # [MOD] PendingBanner 추가
│   └── ProfilePage.tsx                      # [MOD] 내 학교 섹션
└── App.tsx                                  # [MOD] EnrollmentProvider 추가

supabase-schema.sql                          # [NEW] 전체 DB 스키마
.env.local                                   # [NEW] Supabase 환경변수
```

---

## Enrollment 상태 흐름

```
[관리자가 학교 연결]
        ↓
   pending_info  ←── 학생 다음 로그인 시 추가정보 모달 표시
        ↓
     active      ←── 추가정보 입력 완료
        ↓
    completed    ←── 과정 수료

   active → suspended (관리자가 일시정지)
   suspended → active (관리자가 재활성화)
```

---

## Supabase 프로젝트 정보

- **Project ID:** wcjeytljpqvwfyspewlz
- **URL:** https://wcjeytljpqvwfyspewlz.supabase.co
- **Region:** 확인 필요
